@using Microsoft.JSInterop
@using MudBlazor.Services
@inherits LayoutComponentBase
@implements IBrowserViewportObserver
@inject IJSRuntime JS

<MudLayout>
    <MudAppBar Color="Color.Primary" Elevation="1">
        <MudIconButton Icon="@Icons.Material.Filled.Menu"
                       Color="Color.Inherit"
                       Edge="Edge.Start"
                       OnClick="@ToggleDrawer" />
        <MudText Typo="Typo.h6">Tesla Cam Viewer</MudText>
    </MudAppBar>

    <MudDrawer @bind-Open="@_drawerOpen"
               ClipMode="DrawerClipMode.Always"
               Elevation="1"
               Width="400px"
               Variant="@DrawerVariant.Responsive"
               Breakpoint="Breakpoint.Md">
        <MudDrawerContainer>
            <MudGrid Style="margin-top:10px">
                <!-- Statistics Section -->
                <MudItem xs="12">
                    <MudPaper Class="pa-3 mb-2" Elevation="3">
                        <MudStack Spacing="2">
                            <MudText Typo="Typo.h6" Align="Align.Center">Statistics</MudText>
                            <MudText>Breakpoint: @_currentBreakpoint</MudText>
                            <MudGrid Spacing="1">
                                <MudItem xs="6">
                                    <MudPaper Class="pa-2" Style="background-color: var(--mud-palette-primary); color: white;">
                                        <MudStack Spacing="0" AlignItems="AlignItems.Center">
                                            <MudText Typo="Typo.h4">@_totalEvents</MudText>
                                            <MudText Typo="Typo.caption">Total Events</MudText>
                                        </MudStack>
                                    </MudPaper>
                                </MudItem>
                                <MudItem xs="6">
                                    <MudPaper Class="pa-2" Style="background-color: var(--mud-palette-secondary); color: white;">
                                        <MudStack Spacing="0" AlignItems="AlignItems.Center">
                                            <MudText Typo="Typo.h4">@_eventsThisMonth</MudText>
                                            <MudText Typo="Typo.caption">This Month</MudText>
                                        </MudStack>
                                    </MudPaper>
                                </MudItem>
                                <MudItem xs="6">
                                    <MudPaper Class="pa-2" Style="background-color: var(--mud-palette-tertiary); color: white;">
                                        <MudStack Spacing="0" AlignItems="AlignItems.Center">
                                            <MudText Typo="Typo.h4">@_sentryEvents</MudText>
                                            <MudText Typo="Typo.caption">Sentry</MudText>
                                        </MudStack>
                                    </MudPaper>
                                </MudItem>
                                <MudItem xs="6">
                                    <MudPaper Class="pa-2" Style="background-color: var(--mud-palette-info); color: white;">
                                        <MudStack Spacing="0" AlignItems="AlignItems.Center">
                                            <MudText Typo="Typo.h4">@_savedEvents</MudText>
                                            <MudText Typo="Typo.caption">Saved</MudText>
                                        </MudStack>
                                    </MudPaper>
                                </MudItem>
                            </MudGrid>

                            <MudButton Href="/statistics"
                                       Variant="Variant.Text"
                                       Color="Color.Primary"
                                       FullWidth="true"
                                       EndIcon="@Icons.Material.Filled.ArrowForward">
                                View Detailed Statistics
                            </MudButton>
                        </MudStack>
                    </MudPaper>
                </MudItem>

                <MudItem xs="12">
                    <MudText class="d-flex align-center justify-center" Typo="Typo.h6">Select Date</MudText>
                </MudItem>
                <MudItem xs="12">
                    <MudDatePicker class="d-flex align-center justify-center"
                                   Label="Select Date"
                                   PickerVariant="PickerVariant.Static"
                                   IsDateDisabledFunc="IsNotEventDate"
                                   AdditionalDateClassesFunc="GetDateStyle"
                                   DateChanged="OnDateSelected" />
                </MudItem>
                <MudItem xs="12">
                    <MudText class="d-flex align-center justify-center" Typo="Typo.h6">Clips</MudText>
                </MudItem>
                <MudItem xs="12">
                    <MudStack Spacing="2">
                        @foreach (var theEvent in _eventsSelected)
                        {
                            <MudPaper Elevation="4" Class="teslacam-card">
                                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" Class="teslacam-row">

                                    <!-- Thumb -->
                                    <div class="teslacam-thumb-wrap">
                                        <MudImage Src="@theEvent.Thumbnail"
                                                  Alt="clip thumbnail"
                                                  Class="teslacam-thumb"
                                                  ObjectFit="ObjectFit.Cover" />
                                    </div>

                                    <!-- Info -->
                                    <div class="teslacam-info">
                                        <MudText Typo="Typo.h6" Class="teslacam-title">@theEvent.Event?.Source</MudText>
                                        <MudText Typo="Typo.body2" Class="teslacam-sub">@theEvent.Event?.City</MudText>
                                    </div>

                                    <!-- Right -->
                                    <div class="teslacam-right">
                                        <div class="teslacam-meta">
                                            <MudText Typo="Typo.subtitle1" Class="teslacam-time">
                                                @(theEvent.Event.TimeStamp.ToString("HH:mm:ss") ?? "")
                                            </MudText>
                                            <MudText Typo="Typo.caption" Class="teslacam-day">
                                                @(theEvent.Event.TimeStamp.ToString("ddd") ?? "")
                                            </MudText>
                                        </div>

                                        <MudButton OnClick="() => OnClipClicked(theEvent)"
                                                   Color="Color.Primary"
                                                   Variant="Variant.Filled"
                                                   Size="Size.Small"
                                                   StartIcon="@Icons.Material.Filled.PlayArrow"
                                                   Class="teslacam-show">
                                            Show
                                        </MudButton>
                                    </div>

                                </MudStack>
                            </MudPaper>
                        }
                    </MudStack>
                </MudItem>
            </MudGrid>
        </MudDrawerContainer>
    </MudDrawer>

    <MudMainContent>
        <CascadingValue Value="@SelectedEvent">
            @Body
        </CascadingValue>
    </MudMainContent>
</MudLayout>

@code {
    [Inject]
    private IBrowserViewportService BrowserViewportService { get; set; } = null!;
    private bool _drawerOpen = true;
    public ClipItem? SelectedEvent { get; set; }
    private Breakpoint _currentBreakpoint;

    Guid IBrowserViewportObserver.Id { get; } = Guid.NewGuid();

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await BrowserViewportService.SubscribeAsync(this, fireImmediately: true);
        }
        await base.OnAfterRenderAsync(firstRender);
    }

    ResizeOptions IBrowserViewportObserver.ResizeOptions { get; } = new()
    {
        ReportRate = 250,
        NotifyOnBreakpointOnly = true
    };

    private void ToggleDrawer()
    {
        _drawerOpen = !_drawerOpen;
    }

    private async Task OnClipClicked(ClipItem clipItem)
    {
        SelectedEvent = clipItem;
        if (_currentBreakpoint < Breakpoint.Md)
        {
            _drawerOpen = false;
        }
        StateHasChanged();
    }

    Task IBrowserViewportObserver.NotifyBrowserViewportChangeAsync(BrowserViewportEventArgs browserViewportEventArgs)
    {
        _currentBreakpoint = browserViewportEventArgs.Breakpoint;
        return InvokeAsync(StateHasChanged);
    }
}
