@page "/test-detection"
@inject IDbContextFactory<AppDbContext> DbFactory

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudText Typo="Typo.h3" Class="mb-4">Real-Time Object Detection Test</MudText>

    @if (_cameras.Any())
    {
        <MudSelect T="int" Label="Select Camera" @bind-Value="_selectedCameraId" Class="mb-4">
            @foreach (var camera in _cameras)
            {
                <MudSelectItem Value="@camera.Id">
                    Camera @camera.Id - @camera.CameraName (@camera.EventId)
                </MudSelectItem>
            }
        </MudSelect>

        @if (_selectedCameraId > 0)
        {
            <MudPaper Class="pa-4" Elevation="3">
                <DetectionVideoPlayer CameraId="@_selectedCameraId" />
            </MudPaper>
        }
    }
    else if (_loading)
    {
        <MudProgressCircular Indeterminate Color="Color.Primary" />
        <MudText>Loading cameras...</MudText>
    }
    else
    {
        <MudAlert Severity="Severity.Info">No cameras found. Process some events first!</MudAlert>
    }
</MudContainer>

@code {
    private bool _loading = true;
    private List<Camera> _cameras = new();
    private int _selectedCameraId;

    protected override async Task OnInitializedAsync()
    {
        await using var db = await DbFactory.CreateDbContextAsync();
        _cameras = await db.Cameras.OrderByDescending(c => c.Id).Take(10).ToListAsync();
        if (_cameras.Any())
        {
            _selectedCameraId = _cameras.First().Id;
        }
        _loading = false;
    }
}
