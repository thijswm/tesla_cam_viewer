@page "/"
@using TeslaCamViewer.Data
@using TeslaCamViewer.Shared

<MudContainer MaxWidth="MaxWidth.ExtraExtraLarge" Class="mt-2">
    <MudText Typo="Typo.h5" Class="mb-2">Tesla Cam Viewer</MudText>


    @if (SelectedEvent is not null)
    {
        @if (isLoadingCameras)
        {
            <MudStack AlignItems="AlignItems.Center" Spacing="3" Class="pa-8">
                <MudProgressCircular Indeterminate Color="Color.Primary" Size="Size.Large" />
                <MudText Typo="Typo.h6">Loading cameras...</MudText>
            </MudStack>
        }
        else if (cameras != null && cameras.Count > 0)
        {
            <!-- Timeline Seekbar -->
            <MudPaper Class="pa-3 mb-2" Elevation="3" Style="max-width: 1400px; margin: 0 auto;">
                <MudStack Spacing="1">
                    <MudText Typo="Typo.subtitle2" Align="Align.Center">Timeline</MudText>
                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                        <!-- Play/Pause Controls -->
                        <MudIconButton Icon="@Icons.Material.Filled.PlayArrow"
                                       Color="Color.Primary"
                                       Size="Size.Medium"
                                       OnClick="PlayAllVideos"
                                       aria-label="Play All" />
                        <MudIconButton Icon="@Icons.Material.Filled.Pause"
                                       Color="Color.Secondary"
                                       Size="Size.Medium"
                                       OnClick="PauseAllVideos"
                                       aria-label="Pause All" />

                        <MudText Typo="Typo.caption" Style="min-width: 60px;">@currentTimeFormatted</MudText>
                        <div style="flex: 1; position: relative;">
                            <MudSlider T="double"
                                       Value="@currentTime"
                                       Min="0"
                                       Max="@videoDuration"
                                       Step="0.1"
                                       Color="Color.Primary"
                                       Variant="Variant.Filled"
                                       ValueChanged="OnTimelineChanged"
                                       Style="width: 100%;" />
                            <!-- Time markers -->
                            <div style="display: flex; justify-content: space-between; margin-top: 4px; padding: 0 8px;">
                                @for (int i = 0; i <= GetTimeMarkerCount(); i++)
                                {
                                    var markerTime = (videoDuration / GetTimeMarkerCount()) * i;
                                    <MudText Typo="Typo.caption" Style="font-size: 10px; color: rgba(255,255,255,0.6);">
                                        @FormatTime(markerTime)
                                    </MudText>
                                }
                            </div>
                        </div>
                        <MudText Typo="Typo.caption" Style="min-width: 60px;">@durationFormatted</MudText>
                    </MudStack>
                </MudStack>
            </MudPaper>

            <!-- Control Buttons -->
            <MudStack Row="true" Justify="Justify.Center" Spacing="2" Class="mb-2">
                <MudButton Variant="Variant.Outlined"
                           Color="Color.Default"
                           Size="Size.Small"
                           StartIcon="@Icons.Material.Filled.FastRewind"
                           OnClick="SkipBackward">
                    -5s
                </MudButton>
                <MudButton Variant="Variant.Outlined"
                           Color="Color.Default"
                           Size="Size.Small"
                           EndIcon="@Icons.Material.Filled.FastForward"
                           OnClick="SkipForward">
                    +5s
                </MudButton>
            </MudStack>

            <!-- Tesla Camera Layout - All Videos Playing -->
            <MudStack Spacing="2" Style="max-width: 1400px; margin: 0 auto;">

                <!-- Row 1: Front Camera -->
                <MudGrid Justify="Justify.Center">
                    <MudItem xs="12" md="8">
                        @{
                            var frontCamera = GetCameraByName("front");
                            if (frontCamera != null)
                            {
                                <MudPaper Class="pa-2" Elevation="3">
                                    <MudStack Spacing="1">
                                        <MudText Typo="Typo.subtitle1" Align="Align.Center" Style="font-weight: 600;">Front Camera</MudText>
                                        <video id="video-front"
                                               controls
                                               style="width: 100%; max-height: 25vh; border-radius: 6px; background: #000;"
                                               data-camera="front">
                                            <source src="@GetVideoUrl(frontCamera)" type="video/mp4">
                                            Your browser does not support the video tag.
                                        </video>
                                    </MudStack>
                                </MudPaper>
                            }
                        }
                    </MudItem>
                </MudGrid>

                <!-- Row 2: Left and Right Repeater Cameras -->
                <MudGrid>
                    <MudItem xs="12" md="6">
                        @{
                            var leftCamera = GetCameraByName("left_repeater");
                            if (leftCamera != null)
                            {
                                <MudPaper Class="pa-2" Elevation="3">
                                    <MudStack Spacing="1">
                                        <MudText Typo="Typo.subtitle1" Align="Align.Center" Style="font-weight: 600;">Left Repeater</MudText>
                                        <video id="video-left_repeater"
                                               controls
                                               style="width: 100%; max-height: 25vh; border-radius: 6px; background: #000;"
                                               data-camera="left_repeater">
                                            <source src="@GetVideoUrl(leftCamera)" type="video/mp4">
                                            Your browser does not support the video tag.
                                        </video>
                                    </MudStack>
                                </MudPaper>
                            }
                        }
                    </MudItem>
                    <MudItem xs="12" md="6">
                        @{
                            var rightCamera = GetCameraByName("left_repeater");
                            if (rightCamera != null)
                            {
                                <MudPaper Class="pa-2" Elevation="3">
                                    <MudStack Spacing="1">
                                        <MudText Typo="Typo.subtitle1" Align="Align.Center" Style="font-weight: 600;">Right Repeater</MudText>
                                        <video id="video-right_repeater"
                                               controls
                                               style="width: 100%; max-height: 25vh; border-radius: 6px; background: #000;"
                                               data-camera="right_repeater">
                                            <source src="@GetVideoUrl(rightCamera)" type="video/mp4">
                                            Your browser does not support the video tag.
                                        </video>
                                    </MudStack>
                                </MudPaper>
                            }
                        }
                    </MudItem>
                </MudGrid>

                <!-- Row 3: Back Camera -->
                <MudGrid Justify="Justify.Center">
                    <MudItem xs="12" md="8">
                        @{
                            var backCamera = GetCameraByName("back");
                            if (backCamera != null)
                            {
                                <MudPaper Class="pa-2" Elevation="3">
                                    <MudStack Spacing="1">
                                        <MudText Typo="Typo.subtitle1" Align="Align.Center" Style="font-weight: 600;">Back Camera</MudText>
                                        <video id="video-back"
                                               controls
                                               style="width: 100%; max-height: 25vh; border-radius: 6px; background: #000;"
                                               data-camera="back">
                                            <source src="@GetVideoUrl(backCamera)" type="video/mp4">
                                            Your browser does not support the video tag.
                                        </video>
                                    </MudStack>
                                </MudPaper>
                            }
                        }
                    </MudItem>
                </MudGrid>
            </MudStack>
        }
    }
    else
    {
        <MudAlert Severity="Severity.Normal">Select an event from the sidebar to view clips.</MudAlert>
    }
</MudContainer>